<!DOCTYPE html>
<html lang="en-GB">
<head>
<title>Automate</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link rel="stylesheet" type="text/css" href="../css/endmedia.css" />
<link rel="stylesheet" type="text/css" href="../../endfw/vue/layout.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orychung/endfw@0.5.1/vue/control.css" />
<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.8/dist/jsmediatags.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/orychung/endfw@0.5.1/lib/jquery.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/orychung/endfw@0.5.1/lib/vue.global.prod.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/orychung/endfw@0.5.1/common/builtin.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/orychung/endfw@0.5.1/common/global.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/orychung/endfw@0.5.1/common/promise.js"></script>
<script type="text/javascript" src="../../endfw/client/music.js" charset="utf-8"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/orychung/endfw@0.5.1/client/shortcuts.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/orychung/endfw@0.5.1/client/quick_vue.js"></script>
<style>
vueTemplate {
  display: none;
}
</style>
<script type="text/javascript" id="method">
Object.assign(Vue.endAddOn.commonMethods, {
  async testInit() {
    await http.get('/dev/loadDynamic');
    await http.get('/metadata/init');
  },
  changeLibrary() {
    //TODO: define share-able UI for quick input
  },
});
</script>
<script type="text/javascript" id="model">
class MediaFile {
  constructor(...args) {
    Object.assign(this, ...args);
  }
  async load() {
    if (this.data == undefined) this.data = await http.post.asBinary('/mediaFile/readFile', {library: this.library, path: this.path});
    return this;
  };
  async loadAudio() {
    await this.load();
    await g.audioBuffer.load(this.data);
    return this;
  };
  async register() {
    let tags = (await this.mediaTags()).tags; //TODO: wrap this in try block
    all.files[this.path] = {
      path: this.path,
      title: tags.title,
      performer: tags.artist,
      year: tags.TDRC?.data,
      album: tags.album,
      'track#': tags.track.split('/')[0],
    };
    all.thumbnails[this.path] = tags.picture;
  }
  async start(...args) {
    this.pause(this);
    await this.loadAudio();
    g.audioBuffer.restart(...args);
  }
  pause() {
    g.audioBuffer.stop();
  }
  async mediaTags() {
    await this.load();
    let c = triggerFactory();
    window.jsmediatags.read(new Blob([this.data]),{
      onSuccess:(tags)=>c.fire(tags),
      onError:(e)=>c.cancel(e)
    });
    return c.promise;
  }
}
</script>
<script type="text/javascript" id="main">
async function initPage() {
  globalThis.all = g;
  g.ui = {
    themeFaceHue: 120,
    current: {},
  };
  g.audio = {ctx: new AudioContext()};
  g.audioBuffer = new MusicalBuffer(g.audio.ctx);

  //await Vue.endAddOn.loadTemplateURLs('https://cdn.jsdelivr.net/gh/orychung/endfw@0.5.1/vue/control.xml');
  await Vue.endAddOn.loadTemplateURLs('../../endfw/vue/control.xml');
  Vue.endAddOn.templates = Vue.endAddOn.templates.concat(Array.from($('vueTemplate')));
  Vue.endAddOn.createApp({
    mountSelectors: ['#screen'],
  });

  initData();
}

async function initData() {
  await http.get('/metadata/init');
  g.settings = await http.get('/metadata/settings');
  g.thumbnails = await http.get('/metadata/thumbnails');
  g.files = await http.get('/metadata/files');
  g.metadata = await http.get('/metadata/metadata');
  g.libraries = {};
  let libraryList = await http.get('/metadata/listLibrary');
  for await (const x of
    libraryList.map(async x=>[
      x,
      await http.post('/metadata/listFiles', {library: x})
    ])
  ) {
    all.libraries[x[0]] = {
      path: x[0],
      files: x[1].mapObject(file=>new MediaFile(file, {library: x[0]})),
    };
  }
  if (libraryList.length) all.ui.current.library = libraryList[0];
  all.ui.fileGrid = {
    filter: {
      path: d=>{
        if (!all.ui.fileGrid.filterPath) return true;
        return d.path.includes(all.ui.fileGrid.filterPath);
      },
    },
    sorting: {},
    columns: [
      { heading: 'Path', display: d=>d.path },
      { heading: 'Actions', template: 't-media-actions' },
    ],
    data: all.libraries[all.ui.current.library].files,
  };
}

</script>
</head>
<vueTemplates>
  <vueTemplate id="t-media-actions">
    <button @click="od.row.start()">Play</button>
    <button v-if="!(od.row.path in all.files)" @click="od.row.register()">Register</button>
  </vueTemplate>
</vueTemplates>
<body onload="initPage()">
<flex-layout id="screen" class="row flex-stretch full-size">
  <flex-layout class="col vscroll tool">
    <button @click="testInit">Re-Init</button>
    <button @click="changeLibrary">Change Library</button>
  </flex-layout>
  <flex-layout class="col vscroll flex-remain">
    <div v-if="all.ui.fileGrid">
      <span>
        <label for="pathFilter">Path Filter</label>
        <input id="pathFilter" type="text" v-model="all.ui.fileGrid.filterPath"></input>
      </span>
      <t-list-grid :od="all.ui.fileGrid" :all="all"></t-list-grid>
    </div>
  </flex-layout>
  <screen-layer style="--base-z-index:20;">
    <t-cover :all="all"></t-cover>
    <t-contextmenu :all="all" :w="all.ui.contextmenus"></t-contextmenu>
  </screen-layer>
</flex-layout>
</body>
</html>
